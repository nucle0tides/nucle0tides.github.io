---
import BaseLayout from '../layouts/BaseLayout.astro';
import PageHeader from '../components/PageHeader.astro';
import { getCollection, getEntry } from 'astro:content';
import * as currentsStyles from '../components/Currents.css';
import * as styles from './index.css';

const posts = (await getCollection('posts')).sort(
  (a, b) => (b.data.modified?.valueOf() ?? 0) - (a.data.modified?.valueOf() ?? 0)
);

const currents = await getEntry('currents', 'currents');
const currentsData = currents?.data ?? {};
---

<BaseLayout title="~/">
  {Object.keys(currentsData).length > 0 && (
    <div class={currentsStyles.currentsWrapper}>
      <span class={currentsStyles.currentsTrack}>
        {[0, 1].map(() => (
          <span class={currentsStyles.currentsContent}>
            {Object.entries(currentsData).map(([key, value], index) => {
              const isObject = typeof value === 'object' && value !== null;
              const text = isObject ? value.text : value;
              const url = isObject ? value.url : null;
              return (
                <>
                  {index > 0 && <span class={currentsStyles.separator}>&bull;</span>}
                  {url ? (
                    <a href={url} class={currentsStyles.currentLink}>
                      <span class={currentsStyles.currentKey}>current {key}:</span> {text}
                    </a>
                  ) : (
                    <span>
                      <span class={currentsStyles.currentKey}>current {key}:</span> {text}
                    </span>
                  )}
                </>
              );
            })}
            <span class={currentsStyles.separator}>&bull;</span>
          </span>
        ))}
      </span>
    </div>
  )}
  <PageHeader title="recent posts" />
  <ul class={styles.postList}>
    {posts.map((post) => {
      const date = post.data.modified;
      const formattedDate = date ? `${String(date.getUTCMonth() + 1).padStart(2, '0')} • ${String(date.getUTCDate()).padStart(2, '0')} • ${String(date.getUTCFullYear()).slice(-2)}` : null;
      return (
        <li class={styles.postItem}>
          <div class={styles.postContent}>
            <a href={`/posts/${post.slug}`}>
              <span class={styles.postTitle}>{post.data.title}</span>
            </a>
            {post.data.excerpt && <p class={styles.postExcerpt}>{post.data.excerpt}</p>}
          </div>
          {formattedDate && (
            <time class={styles.postDate} datetime={date?.toISOString()}>
              {formattedDate}
            </time>
          )}
        </li>
      );
    })}
  </ul>
</BaseLayout>
